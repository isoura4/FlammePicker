<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Commandes en temps réel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    #commandes {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .commande {
      border: 1px solid #ccc;
      background-color: #fff;
      padding: 10px;
      margin: 10px;
      width: 300px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    .commande p {
      margin: 5px 0;
    }
    .commande button {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
    }
    .commande button:hover {
      background-color: #218838;
    }
    #login {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 50px;
    }
    #login input, #login button {
      margin: 5px;
    }
    #compteur {
      text-align: center;
      font-size: 1.2em;
      margin-top: 20px;
    }
  </style>
  <script type="module">
    // Importation des modules Firebase
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-app.js';
    import { getFirestore, collection, onSnapshot, doc, deleteDoc, getDoc, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore.js';
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.0.0/firebase-auth.js';

    // Configuration Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyC6W3jUKG1yjyJBCvcvS06ZPSixrOilWoo",
      authDomain: "pizzapp-9e078.firebaseapp.com",
      projectId: "pizzapp-9e078",
      storageBucket: "pizzapp-9e078.appspot.com",
      messagingSenderId: "254766148779",
      appId: "1:254766148779:web:22aa8a71a69c9a391ddbee"
    };

    // Initialisation de Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const commandesDiv = document.getElementById('commandes');
    const loginDiv = document.getElementById('login');
    const compteurDiv = document.getElementById('compteur');

    let compteur = 0;
    const compteurDocRef = doc(db, "compteurs", "commandesValidees");

    // Fonction d'authentification de l'utilisateur
    window.login = function(email, password) {
      signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
          console.log('Utilisateur connecté:', userCredential.user);
          afficherCommandes();
          recupererCompteur();
        })
        .catch((error) => {
          console.error('Erreur de connexion:', error);
        });
    }

    // Fonction d'affichage des commandes
    function afficherCommandes() {
      onSnapshot(collection(db, "commandes"), (querySnapshot) => {
        commandesDiv.innerHTML = "";  // Clear previous commands
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          const commandeDiv = document.createElement('div');
          commandeDiv.className = 'commande';
          commandeDiv.id = doc.id;

          let commandeHTML = `
            <p><strong>Nom:</strong> ${data.nom_user}</p>
          `;

          const champs = ['beurre_escargo', 'champignons', 'chevre', 'chevre_Miel', 'gratine', 'normal'];
          const labels = {
            beurre_escargo: 'Beurre escargot',
            champignons: 'Champignons',
            chevre: 'Chèvre',
            chevre_Miel: 'Chèvre Miel',
            gratine: 'Gratiné',
            normal: 'Normal'
          };

          champs.forEach(champ => {
            if (data[champ] > 0) {
              commandeHTML += `<p><strong>${labels[champ]}:</strong> ${data[champ]}</p>`;
            }
          });

          commandeHTML += `<button onclick="validerCommande('${doc.id}')">Valider</button>`;
          commandeDiv.innerHTML = commandeHTML;
          commandesDiv.appendChild(commandeDiv);
        });
      });
    }

    // Fonction de validation de commande
    window.validerCommande = async function(id) {
      await deleteDoc(doc(db, "commandes", id));
      const commandeDiv = document.getElementById(id);
      if (commandeDiv) {
        commandeDiv.remove();
        compteur++;
        compteurDiv.textContent = `Nombre total de commandes validées : ${compteur}`;
        console.log("Commande validée et supprimée!");
        await updateCompteurInFirestore();
      }
    };

    // Fonction pour récupérer le compteur depuis Firestore
    async function recupererCompteur() {
      const compteurDoc = await getDoc(compteurDocRef);
      if (compteurDoc.exists()) {
        compteur = compteurDoc.data().valeur;
        compteurDiv.textContent = `Nombre total de commandes validées : ${compteur}`;
      } else {
        // Si le document n'existe pas, le créer avec une valeur initiale de 0
        await setDoc(compteurDocRef, { valeur: 0 });
        compteur = 0;
        compteurDiv.textContent = `Nombre total de commandes validées : 0`;
      }
    }

    // Fonction pour mettre à jour le compteur dans Firestore
    async function updateCompteurInFirestore() {
      try {
        await updateDoc(compteurDocRef, { valeur: compteur });
        console.log('Compteur mis à jour dans Firestore:', compteur);
      } catch (error) {
        console.error('Erreur lors de la mise à jour du compteur:', error);
      }
    }

    // Authentification de l'utilisateur lors du chargement de la page
    onAuthStateChanged(auth, (user) => {
      if (user) {
        loginDiv.style.display = 'none';
        commandesDiv.style.display = 'flex';
        afficherCommandes();
        recupererCompteur();
      } else {
        loginDiv.style.display = 'flex';
        commandesDiv.style.display = 'none';
      }
    });

    // Fonction pour empêcher la mise en veille
    let wakeLock = null;
    async function requestWakeLock() {
      try {
        wakeLock = await navigator.wakeLock.request('screen');
        console.log('Wake Lock activé');
      } catch (err) {
        console.error(`${err.name}, ${err.message}`);
      }
    }

    document.addEventListener('visibilitychange', async () => {
      if (wakeLock !== null && document.visibilityState === 'visible') {
        await requestWakeLock();
      }
    });

    requestWakeLock();

  </script>
</head>
<body>
  <h1>Liste des commandes</h1>
  <div id="login">
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Mot de passe">
    <button onclick="window.login(document.getElementById('email').value, document.getElementById('password').value)">Connexion</button>
  </div>
  <div id="commandes"></div>
  <div id="compteur">Nombre total de commandes validées : 0</div>
</body>
</html>
